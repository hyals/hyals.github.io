<!DOCTYPE html>
<html lang="en" class="mdui-theme-light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Novel Reader</title>

  <!-- Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" />

  <!-- MDUI -->
  <link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css" />
  <script src="https://unpkg.com/mdui@2/mdui.global.js" defer></script>

   <!-- main.css -->
  <link rel="stylesheet" href="https://hyals.ink/divide/main.css" />

  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
</head>
<body>
  <div id="scrollContainer">
    <main style="max-width: 900px;">
      <!-- Top App Bar -->
  <mdui-top-app-bar class="appbar" scroll-behavior="elevate" scroll-target="#scrollContainer">
    <mdui-button-icon icon="book"></mdui-button-icon>

    <mdui-top-app-bar-title style="line-height:1">
      <span style="font-size:16pt;font-weight:400">BEYOND THE DIVIDE</span><br>
      <span style="font-size:10pt;font-weight:500" id="chapter-title"></span>
    </mdui-top-app-bar-title>

    <div style="flex-grow:1"></div>

    <mdui-button-icon id="fontDec" icon="text_decrease" title="Decrease font"></mdui-button-icon>
    <mdui-button-icon id="fontInc" icon="text_increase" title="Increase font"></mdui-button-icon>
    <mdui-switch id="themeSwitch" unchecked-icon="wb_sunny--outlined" checked-icon="nightlight--outlined" title="Toggle theme"></mdui-switch>
  </mdui-top-app-bar>

  <!-- Chapter container -->
  <div id="chapter-container">
    <em>Select a chapter to begin reading...</em>
  </div>

  <!-- Dialog for Chapters -->
  <mdui-dialog close-on-overlay-click class="example-header">
    <mdui-top-app-bar slot="header">
      <mdui-button-icon icon="menu_book"></mdui-button-icon>
      <mdui-top-app-bar-title>Chapters</mdui-top-app-bar-title>
      <mdui-button-icon icon="close" id="close_chapter_list"></mdui-button-icon>
    </mdui-top-app-bar>
    <mdui-list id="chapterList"></mdui-list>
  </mdui-dialog>

  <!-- Bottom App Bar -->
  <mdui-bottom-app-bar scroll-behavior="hide" scroll-threshold="30">
    <mdui-button-icon id="prevChapter" icon="arrow_circle_left" title="Previous"></mdui-button-icon>
    <mdui-slider id="currentChapterValue" min="1" max="2" value="1" step="1"></mdui-slider>
    <mdui-button-icon id="nextChapter" icon="arrow_circle_right" title="Next"></mdui-button-icon>
    <mdui-button-icon icon="format_list_bulleted" id="chapter_list_icon" title="Chapter list"></mdui-button-icon>
  </mdui-bottom-app-bar>
</main>
</div>
<!-- Custom Scrollbar -->
  <div id="scrollTrack" class="scroll-track">
    <div id="thumbWrap" class="scroll-thumb-wrap">
      <button id="thumb" class="scroll-thumb">
        <svg viewBox="0 0 40 40">
          <circle class="ring-bg" cx="20" cy="20" r="14"></circle>
          <circle id="ring" class="ring" cx="20" cy="20" r="14"></circle>
        </svg>
      </button>
    </div>
  </div>

  <script defer>
    /* Cookie helpers */
    function setCookie(name, value, days = 365) {
      const d = new Date();
      d.setTime(d.getTime() + days * 864e5);
      document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;
    }
    function getCookie(name) {
      return document.cookie.split('; ').reduce((r, v) => {
        const [k, val] = v.split('=');
        return k === name ? decodeURIComponent(val) : r;
      }, null);
    }

    /* Character replacements */
    const characterNames = {
      "Hya": { label: "Hya", color: "red" },
      "Lina": { label: "Lina", color: "blue" },
      "Vita": { label: "Vita", color: "blue" },
      "Gaukel": { label: "Gaukel", color: "blue" }
    };
    function applyCharacterReplacements(text) {
      return text.replace(/\[(\w+)\]\s*(.*)/g, (m, key, dialogue) => {
        const char = characterNames[key];
        if (!char) return m;
        return `<fieldset class="character-box ${char.color}"><legend><i class="mdui-icon material-icons" style="vertical-align:middle">person</i> ${char.label}</legend><p>${dialogue}</p></fieldset>`;
      });
    }

    /* Chapter loading */
    async function loadChapter(filePath, num) {
      const container = document.getElementById('chapter-container');
      const titleDiv = document.getElementById('chapter-title');
      container.innerHTML = "<em><mdui-linear-progress></mdui-linear-progress></em>";
      try {
        const res = await fetch(filePath);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        let text = (await res.text()).trim();
        text = applyCharacterReplacements(text);
        const html = marked.parse(text);
        container.innerHTML = html;

        const parsed = new DOMParser().parseFromString(html, 'text/html');
        const h1 = parsed.querySelector('h1');
        titleDiv.textContent = h1 ? h1.textContent : '';
        setCookie('lastChapter', num);
        document.getElementById('currentChapterValue').value = num;
      } catch {
        container.innerHTML = "<em>Could not load chapter.</em>";
        titleDiv.textContent = "";
      }
    }

    /* Navigation */
    function goToChapter(num) {
      const n = parseInt(num, 10);
      if (!isNaN(n)) window.location.hash = n;
    }
    function currentChapterNum() {
      const h = window.location.hash.substring(1);
      return h && !isNaN(h) ? parseInt(h, 10) : null;
    }
    function nextChapter() {
      const n = currentChapterNum();
      if (n !== null) goToChapter(n + 1);
    }
    function prevChapter() {
      const n = currentChapterNum();
      if (n !== null && n > 1) goToChapter(n - 1);
    }
    function handleHashChange() {
      const hash = window.location.hash.substring(1);
      const slider = document.getElementById('currentChapterValue');
      const final_chapter = parseInt(slider.max, 10);
      if (hash && !isNaN(hash)) {
        const n = parseInt(hash, 10);
        loadChapter(`https://hyals.ink/divide/ch/chapter${n}.txt`, n);
        slider.value = n;
        document.getElementById('nextChapter').disabled = (n >= final_chapter);
        document.getElementById('prevChapter').disabled = (n <= 1);
      }
    }

    /* Chapter options */
    function generateChapterOptions() {
      const list = document.getElementById('chapterList');
      const slider = document.getElementById('currentChapterValue');
      const max = parseInt(slider.max, 10) || 1;
      list.innerHTML = '';
      for (let i = 1; i <= max; i++) {
        const item = document.createElement('mdui-list-item');
        item.setAttribute('headline', i);
        item.textContent = i;
        item.addEventListener('click', () => goToChapter(i));
        list.appendChild(item);
      }
    }

    /* Font size */
    function changeFontSize(delta) {
      const c = document.getElementById('chapter-container');
      const cur = parseInt(getComputedStyle(c).fontSize, 10) || 18;
      const next = Math.max(12, cur + delta);
      c.style.fontSize = next + 'px';
      setCookie('fontSize', String(next));
    }

    /* Theme toggle */
    function toggleThemeBySwitch(isChecked) {
      const doc = document.documentElement;
      if (isChecked) {
        doc.classList.add('mdui-theme-dark');
        doc.classList.remove('mdui-theme-light');
        setCookie('theme', 'mdui-theme-dark');
      } else {
        doc.classList.remove('mdui-theme-dark');
        doc.classList.add('mdui-theme-light');
        setCookie('theme', 'mdui-theme-light');
      }
    }

    /* Init */
    window.addEventListener('load', () => {
      const slider = document.getElementById('currentChapterValue');
      const prevBtn = document.getElementById('prevChapter');
      const nextBtn = document.getElementById('nextChapter');
      const fontInc = document.getElementById('fontInc');
      const fontDec = document.getElementById('fontDec');
      const themeSwitch = document.getElementById('themeSwitch');
      const dialog = document.querySelector(".example-header");
      const openButton = document.getElementById("chapter_list_icon");
      const closeButton = document.getElementById("close_chapter_list");
      const container = document.getElementById('chapter-container');

      openButton.addEventListener("click", () => dialog.open = true);
      closeButton.addEventListener("click", () => dialog.open = false);

      generateChapterOptions();
      slider.addEventListener('input', e => goToChapter(e.target.value));
      prevBtn.addEventListener('click', prevChapter);
      nextBtn.addEventListener('click', nextChapter);
      fontInc.addEventListener('click', () => changeFontSize(2));
      fontDec.addEventListener('click', () => changeFontSize(-2));
      themeSwitch.addEventListener('change', e => toggleThemeBySwitch(e.target.checked));

      /* Restore prefs */
      const savedTheme = getCookie('theme');
      if (savedTheme === 'mdui-theme-dark') {
        document.documentElement.classList.add('mdui-theme-dark');
        themeSwitch.checked = true;
      }
      const savedFont = getCookie('fontSize');
      if (savedFont) container.style.fontSize = parseInt(savedFont, 10) + 'px';

      if (!window.location.hash) {
        const last = getCookie('lastChapter');
        goToChapter(last || 1);
      }
      handleHashChange();

    });
    window.addEventListener('hashchange', handleHashChange);
  </script>
   <!-- Custom scrollbar logic -->
  <script defer>
    (() => {
      const wrap = document.getElementById('thumbWrap'),
            thumb = document.getElementById('thumb'),
            track = document.getElementById('scrollTrack'),
            ring = document.getElementById('ring'),
            container = document.getElementById('scrollContainer');

      const R = 14, circumference = 2 * Math.PI * R;
      ring.style.strokeDasharray = circumference;

      let isDragging = false, hideTimeout, targetRatio = 0, animating = false;

      const available = () => window.innerHeight - 48 - 24;

      const showThumb = () => {
        track.classList.remove('hidden');
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => track.classList.add('hidden'), 3000);
      };

      const pointerToRatio = y => Math.min(1, Math.max(0, (y - 12) / available()));

      const setTargetRatio = ratio => {
        targetRatio = Math.min(1, Math.max(0, ratio));
        if (!animating) requestAnimationFrame(animateThumb);
      };

      const animateThumb = () => {
        animating = true;
        const scrollHeight = container.scrollHeight - container.clientHeight;
        const currentRatio = scrollHeight ? container.scrollTop / scrollHeight : 0;
        const delta = targetRatio - currentRatio;
        if (Math.abs(delta) < 0.001) {
          container.scrollTop = scrollHeight * targetRatio;
          animating = false;
          return;
        }
        container.scrollTop = scrollHeight * (currentRatio + delta * 0.3);
        updateThumb();
        requestAnimationFrame(animateThumb);
      };

      const updateThumb = () => {
        const scrollTop = container.scrollTop;
        const scrollHeight = container.scrollHeight - container.clientHeight;
        const ratio = scrollHeight ? scrollTop / scrollHeight : 0;
        wrap.style.transform = `translateY(${12 + available() * ratio}px)`;
        ring.style.strokeDashoffset = circumference * (1 - ratio);
      };

      const dragMove = y => setTargetRatio(pointerToRatio(y));

      const dragStart = e => {
        isDragging = true;
        thumb.setPointerCapture?.(e.pointerId);
        thumb.style.transition = 'none';
      };

      const dragEnd = e => {
        isDragging = false;
        thumb.releasePointerCapture?.(e?.pointerId);
        thumb.style.transition = 'transform 0.15s cubic-bezier(.2, .9, .3, 1)';
      };

      container.addEventListener('scroll', () => { if(!isDragging) updateThumb(); showThumb(); });
      window.addEventListener('resize', () => { updateThumb(); showThumb(); });

      thumb.addEventListener('pointerdown', dragStart);
      document.addEventListener('pointermove', e => isDragging && dragMove(e.clientY));
      document.addEventListener('pointerup', dragEnd);

      thumb.addEventListener('touchstart', e => { if(e.touches.length===1){ isDragging=true; thumb.style.transition='none'; } }, {passive:true});
      document.addEventListener('touchmove', e => { if(isDragging && e.touches.length===1) dragMove(e.touches[0].clientY); }, {passive:false});
      document.addEventListener('touchend', dragEnd);

      track.addEventListener('pointerdown', e => { if(e.target!==thumb){ dragMove(e.clientY); isDragging=true; thumb.setPointerCapture?.(e.pointerId); } });

      document.addEventListener('wheel', e => {
        if(!container.contains(e.target)){
          container.scrollTop += e.deltaY;
          setTargetRatio(container.scrollTop / (container.scrollHeight - container.clientHeight));
          showThumb();
          e.preventDefault();
        }
      }, {passive:false});

      ['pointermove','pointerdown','keydown','touchmove','touchstart'].forEach(evt => document.addEventListener(evt, showThumb));

      setTargetRatio(0);
      showThumb();
    })();
  </script>
</body>
</html>
